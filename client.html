<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f6fa;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            margin-top: 30px;
            color: #273c75;
        }
        #chat-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(44, 62, 80, 0.08);
            width: 100%;
            max-width: 420px;
            margin: 30px 0;
            padding: 24px 18px 12px 18px;
            display: flex;
            flex-direction: column;
        }
        #messages {
            list-style: none;
            padding: 0;
            margin: 0 0 16px 0;
            max-height: 340px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .message {
            max-width: 70%;
            padding: 10px 16px;
            border-radius: 18px;
            position: relative;
            display: inline-block;
        }
        .message-sender {
            font-size: 0.85em;
            color: #888;
            display: block;
            margin-bottom: 2px;
            margin-left: 6px;
            margin-right: 6px;
        }
        .message-time {
            font-size: 0.75em;
            color: #aaa;
            margin-left: 4px;
        }
        .message-content {
            font-size: 1rem;
            word-break: break-word;
        }
        .right {
            align-self: flex-end;
            background: #4cd137;
            color: #fff;
            border-bottom-right-radius: 4px;
        }
        .left {
            align-self: flex-start;
            background: #dff9fb;
            color: #353b48;
            border-bottom-left-radius: 4px;
        }
        .center {
            align-self: center;
            background: #f5f6fa;
            color: #718093;
            font-style: italic;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        #input-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        #messageInput {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #dcdde1;
            font-size: 1rem;
        }
        #sendButton, #connectButton {
            background: #273c75;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 18px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        #sendButton:disabled {
            background: #dcdde1;
            color: #888;
            cursor: not-allowed;
        }
        #userInput, #roomInput {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #dcdde1;
            font-size: 1rem;
            margin-right: 8px;
        }
        .status {
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            text-align: center;
        }
        .status.connected {
            background: #2ed573;
            color: white;
        }
        .status.disconnected {
            background: #ff4757;
            color: white;
        }
        .status.connecting {
            background: #ffa502;
            color: white;
        }
    </style>
</head>
<body>
    <h1>WebSocket Chat</h1>
    <div id="chat-container">
        <div id="status" class="status disconnected">Disconnected</div>
        <div id="input-row">
            <input id="userInput" type="text" placeholder="Username" />
            <input id="roomInput" type="text" placeholder="Room name" />
            <button id="connectButton">Connect</button>
        </div>
        <ul id="messages"></ul>
        <div id="input-row">
            <input id="messageInput" type="text" placeholder="Type a message..." />
            <button id="sendButton" disabled>Send</button>
        </div>
    </div>
    <script>
        const messagesList = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const connectButton = document.getElementById('connectButton');
        const roomInput = document.getElementById('roomInput');
        const userInput = document.getElementById('userInput');
        const statusDiv = document.getElementById('status');

        let socket = null;
        let clientId = null;
        let historyLoaded = false;
        let messageQueue = [];

        connectButton.onclick = function() {
            const username = userInput.value.trim();
            const room = roomInput.value.trim();
            
            if (!username) {
                alert('Please enter a username');
                userInput.focus();
                return;
            }
            
            if (!room) {
                alert('Please enter a room name');
                roomInput.focus();
                return;
            }
            
            if (socket) {
                socket.close();
            }
            let wsUrl = 'ws://localhost:8080/chat';
            let historyUrl = 'http://localhost:8080/history'
            if (room) {
                wsUrl += '?r=' + encodeURIComponent(room);
                historyUrl += '?r=' + encodeURIComponent(room);
            }
            clientId = username;
            if (clientId) {
                wsUrl += '&u=' + encodeURIComponent(clientId);
            }

            historyLoaded = false;
            messageQueue = [];
            
            statusDiv.textContent = 'Connecting...';
            statusDiv.className = 'status connecting';

            socket = new WebSocket(wsUrl);

            socket.onopen = function() {
                sendButton.disabled = false;
                messagesList.innerHTML = '';
                statusDiv.textContent = `Connected to room: ${room}`;
                statusDiv.className = 'status connected';

                fetch(historyUrl)
                .then((resp) => resp.json())
                .then((data) => {
                    data.forEach(msgObj => {
                        let messageItem = renderMessage(msgObj);
                        messagesList.appendChild(messageItem);
                    });
                    messagesList.scrollTop = messagesList.scrollHeight;
                    historyLoaded = true;
                    // Process any queued messages
                    messageQueue.forEach(msgObj => {
                        let messageItem = renderMessage(msgObj);
                        messagesList.appendChild(messageItem);
                        messagesList.scrollTop = messagesList.scrollHeight;
                    });
                    messageQueue = [];
                })
                .catch((err) => {
                    console.error(err);
                    historyLoaded = true;
                })
            };

            socket.onclose = function() {
                sendButton.disabled = true;
                statusDiv.textContent = 'Disconnected';
                statusDiv.className = 'status disconnected';
            };

            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                statusDiv.textContent = 'Connection Error';
                statusDiv.className = 'status disconnected';
            };

            socket.onmessage = function(event) {
                let msgObj;
                try {
                    msgObj = JSON.parse(event.data);
                } catch {
                    msgObj = { content: event.data, sender: "SYSTEM" };
                }
                console.log('message', msgObj)

                if (!historyLoaded) {
                    messageQueue.push(msgObj);
                } else {
                    let messageItem = renderMessage(msgObj);
                    messagesList.appendChild(messageItem);
                    messagesList.scrollTop = messagesList.scrollHeight;
                }
            };
        };

        sendButton.onclick = function() {
            const message = messageInput.value;
            if (socket && socket.readyState === WebSocket.OPEN && message.trim() !== "") {
                socket.send(message);
                messageInput.value = '';
            }
        };

        messageInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                sendButton.click();
            }
        });

        roomInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                connectButton.click();
            }
        });

        function renderMessage(msgObj) {
            if (msgObj.sender === "SYSTEM") {
                const messageItem = document.createElement('li');
                messageItem.classList.add('message', 'center');
                messageItem.textContent = msgObj.content;
                return messageItem;
            }

            const wrapper = document.createElement('li');
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            wrapper.style.alignItems = (clientId && msgObj.sender === clientId) ? 'flex-end' : 'flex-start';

            const senderSpan = document.createElement('div');
            senderSpan.classList.add('message-sender');
            const displayName = (clientId && msgObj.sender === clientId) ? 'me' : msgObj.sender;
            const timeStr = msgObj.timestamp ? new Date(msgObj.timestamp).toLocaleTimeString() : '';
            senderSpan.innerHTML = `${displayName} <span class="message-time">${timeStr}</span>`;
            wrapper.appendChild(senderSpan);

            const messageItem = document.createElement('div');
            messageItem.classList.add('message');
            messageItem.classList.add((clientId && msgObj.sender === clientId) ? 'right' : 'left');

            const contentSpan = document.createElement('div');
            contentSpan.classList.add('message-content');
            contentSpan.textContent = msgObj.content;
            messageItem.appendChild(contentSpan);

            wrapper.appendChild(messageItem);

            return wrapper;
        }
    </script>
</body>
</html>
